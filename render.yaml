// 简单的服务器包装器，用于 Zeabur 部署
import http from 'http';
import { URL } from 'url';
import handler from './api/get.js';

const server = http.createServer(async (req, res) => {
  // 解析 URL
  const url = new URL(req.url, `http://${req.headers.host}`);
  
  // 只处理 /api/get 路径
  if (url.pathname === '/api/get') {
    // 将查询参数转换为对象
    const query = {};
    for (const [key, value] of url.searchParams) {
      query[key] = value;
    }
    
    // 创建兼容的请求对象
    const nodeReq = {
      method: req.method,
      query: query,
      url: req.url
    };
    
    // 调用你的原始处理程序
    await handler(nodeReq, res);
  } else {
    // 健康检查端点
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ 
      message: 'Lyric API Server is running',
      endpoint: '/api/get?track_name=歌曲名&artist_name=歌手名'
    }));
  }
});

const port = process.env.PORT || 3000;
server.listen(port, () => {
  console.log(`🚀 Server running on port ${port}`);
});